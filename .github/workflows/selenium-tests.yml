name: Selenium Test CI/CD Pipeline

# Trigger the workflow on push or pull request to main branch
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    name: Run Selenium Tests
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Check out the code
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    # Step 2: Set up Python
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    # Step 3: Install dependencies
    - name: ðŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # Step 4: Install Chrome and ChromeDriver
    - name: ðŸŒ Set up Chrome and ChromeDriver
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    - name: ðŸ” Verify Chrome installation
      run: |
        chrome --version
        which chrome
    
    # Step 5: Start the Flask application in background
    - name: ðŸš€ Start Flask application
      run: |
        cd app
        python app.py &
        echo $! > flask.pid
        sleep 5  # Wait for Flask to start
      env:
        FLASK_ENV: production
    
    # Step 6: Wait for application to be ready
    - name: â³ Wait for app to be ready
      run: |
        timeout 30 bash -c 'until curl -s http://127.0.0.1:5000 > /dev/null; do sleep 1; done'
        echo "âœ… Application is ready!"
    
    # Step 7: Run Selenium tests
    - name: ðŸ§ª Run Selenium tests
      run: |
        export HEADLESS=true
        export APP_URL=http://127.0.0.1:5000
        python tests/test_selenium.py
      continue-on-error: false
    
    # Step 8: Stop Flask application
    - name: ðŸ›‘ Stop Flask application
      if: always()
      run: |
        if [ -f app/flask.pid ]; then
          kill $(cat app/flask.pid) || true
          rm app/flask.pid
        fi
    
    # Step 9: Upload test artifacts (screenshots on failure)
    - name: ðŸ“¸ Upload artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: |
          screenshots/
          logs/
        retention-days: 7
    
    # Step 10: Generate test report summary
    - name: ðŸ“Š Generate test summary
      if: always()
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** 3.11" >> $GITHUB_STEP_SUMMARY
        echo "**Browser:** Chrome (Headless)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Tests completed! Check logs above for details." >> $GITHUB_STEP_SUMMARY